name: Smoke Test - Dev

on:
  workflow_dispatch:
    inputs:
      triggerFromRepo:
        description: 'This workflow is triggered from which repo'
        required: true
        default: 'From another repo'
      triggerFromWorkflow:
        description: 'Workflow name in triggering repo'
        required: true
        default: 'From workflow name'
      triggerFromRunId:
        description: 'Run_id in triggering repo'
        required: true
        default: 'Run_id'
      triggerFromCommitSHA:
        description: 'Commit SHA in triggering repo'
        required: true
        default: 'Commit SHA'

jobs:
  cypress-run-on-stage:
    runs-on: ubuntu-latest
    name: Cypress Run
    steps:
      - uses: actions/checkout@v2

      - name: print inputs from calling workflow
        run: |
          echo "Trigger From Repo: ${{ github.event.inputs.triggerFromRepo }}"
          echo "Trigger From Workflow: ${{ github.event.inputs.triggerFromWorkflow }}"
          echo "Trigger From RunId: ${{ github.event.inputs.triggerFromRunId }}"
          echo "Trigger From Commit SHA: ${{ github.event.inputs.triggerFromCommitSHA }}"
      - name: Run Smoke Tests
        uses: cypress-io/github-action@v2
        id: cypress_smoke_test
        with:
          browser: chrome
          spec: |
            ./cypress/integration/api_management_portal.spec.js
        env:
          GPR_TOKEN: ${{ secrets.GPR_TOKEN }}
          CYPRESS_baseUrl: https://ue2dblkchnapi01.developer.azure-api.net
          CYPRESS_email: "test.blockchain.ey@gmail.com"
          CYPRESS_password: "manaf@123"

      - uses: actions/upload-artifact@v1
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos

  postman-run-on-dev:
    runs-on: ubuntu-latest
    name: Postman Run
    steps:
      - uses: actions/checkout@v2

      - name: print inputs from calling workflow
        run: |
          echo "Trigger From Repo: ${{ github.event.inputs.triggerFromRepo }}"
          echo "Trigger From Workflow: ${{ github.event.inputs.triggerFromWorkflow }}"
          echo "Trigger From RunId: ${{ github.event.inputs.triggerFromRunId }}"
          echo "Trigger From Commit SHA: ${{ github.event.inputs.triggerFromCommitSHA }}"
          
      - name: Prepare Newman-Postman Integration Environment and Scripts for Tokenization
        if: "!contains(steps.commit_msg.outputs.message, 'skip e2e test')"
        env:
          DEVELOPER_PORTAL_URL: 'https:\/\/ue2dblkchnapi01.azure-api.net\/opschain-tokenization'
          CLIENT_ID: '628f41921ea63fbf63c4bb6f'
          CLIENT_SECRET: '4b0d2f36-9eba-48e5-96de-21c2978cb406'
          CLIENT_ID2: '628f41521ea63fbf63c4bb6e'
          CLIENT_SECRET2: 'cc5cf640-f211-42cd-a38d-6cea847496f3'
          SUBSCRIPTION_KEY: '8341fa246f76468083082aa825528836'
          PARTNER_WALLET: '0x104911392a759BcD9cAb4d77E34c61842F0a6314'
        run: |
          sed -i -- "s/{{clientID}}/$CLIENT_ID/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{clientSecret}}/$CLIENT_SECRET/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{clientID2}}/$CLIENT_ID2/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{clientSecret2}}/$CLIENT_SECRET2/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{subscriptionKey}}/$SUBSCRIPTION_KEY/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{partnerWallet}}/$PARTNER_WALLET/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{developerPortalUrl}}/$DEVELOPER_PORTAL_URL/" ./postman/envs/Developer-portal.postman_environment.json

      - name: Execute Newman-Postman Integration Test for Tokenization
        if: "!contains(steps.commit_msg.outputs.message, 'skip e2e test')"
        run: |
          newman run "./postman/collections/API-Gateway-ERC721-Regression-Tests.postman_collection.json" --environment "./postman/envs/Developer-portal.postman_environment.json" --insecure 