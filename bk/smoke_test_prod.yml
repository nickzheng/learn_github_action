name: Smoke Test - Production

on:
  workflow_dispatch:
    inputs:
      triggerFromRepo:
        description: 'This workflow is triggered from which repo'
        required: true
        default: 'From another repo'
      triggerFromWorkflow:
        description: 'Workflow name in triggering repo'
        required: true
        default: 'From workflow name'
      triggerFromRunId:
        description: 'Run_id in triggering repo'
        required: true
        default: 'Run_id'
      triggerFromCommitSHA:
        description: 'Commit SHA in triggering repo'
        required: true
        default: 'Commit SHA'

jobs:
  cypress-run-on-stage:
    runs-on: ubuntu-latest
    name: Cypress Run
    steps:
      - uses: actions/checkout@v2

      - name: print inputs from calling workflow
        run: |
          echo "Trigger From Repo: ${{ github.event.inputs.triggerFromRepo }}"
          echo "Trigger From Workflow: ${{ github.event.inputs.triggerFromWorkflow }}"
          echo "Trigger From RunId: ${{ github.event.inputs.triggerFromRunId }}"
          echo "Trigger From Commit SHA: ${{ github.event.inputs.triggerFromCommitSHA }}"

      - name: Run Smoke Tests
        uses: cypress-io/github-action@v2
        id: cypress_smoke_test
        with:
          browser: chrome
          spec: |
            ./cypress/integration/api_management_portal.spec.js
        env:
          GPR_TOKEN: ${{ secrets.GPR_TOKEN }}
          CYPRESS_baseUrl: https://developer-portal.blockchain.ey.com
          CYPRESS_email: "test.blockchain.ey@gmail.com"
          CYPRESS_password: "manaf@123"

      - uses: actions/upload-artifact@v1
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos

  postman-run-on-prod:
    runs-on: ubuntu-latest
    name: Postman Run
    steps:
      - uses: actions/checkout@v2

      - name: print inputs from calling workflow
        run: |
          echo "Trigger From Repo: ${{ github.event.inputs.triggerFromRepo }}"
          echo "Trigger From Workflow: ${{ github.event.inputs.triggerFromWorkflow }}"
          echo "Trigger From RunId: ${{ github.event.inputs.triggerFromRunId }}"
          echo "Trigger From Commit SHA: ${{ github.event.inputs.triggerFromCommitSHA }}"
          
      - name: Prepare Newman-Postman Integration Environment and Scripts for Tokenization
        if: "!contains(steps.commit_msg.outputs.message, 'skip e2e test')"
        env:
          DEVELOPER_PORTAL_URL: 'https:\/\/developer-portal.blockchain.ey.com\/opschain-tokenization'
          CLIENT_ID: '624c0de7a722437673a45870'
          CLIENT_SECRET: '149e2762-a8be-4d6f-bc6a-96b6e883656b'
          CLIENT_ID2: '628b6db0d658a909a54bbd1d'
          CLIENT_SECRET2: '79ddad9d-1887-4e63-ab21-caa315738b25'
          SUBSCRIPTION_KEY: 'e0d4071a2e1148498ad9bb39313b65e1'
          PARTNER_WALLET: '0x562081598f859733A0ee17cD2c14d30136dBBb3d'
        run: |
          sed -i -- "s/{{clientID}}/$CLIENT_ID/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{clientSecret}}/$CLIENT_SECRET/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{clientID2}}/$CLIENT_ID2/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{clientSecret2}}/$CLIENT_SECRET2/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{subscriptionKey}}/$SUBSCRIPTION_KEY/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{partnerWallet}}/$PARTNER_WALLET/" ./postman/envs/Developer-portal.postman_environment.json
          sed -i -- "s/{{developerPortalUrl}}/$DEVELOPER_PORTAL_URL/" ./postman/envs/Developer-portal.postman_environment.json

      - name: Execute Newman-Postman Integration Test for Tokenization
        if: "!contains(steps.commit_msg.outputs.message, 'skip e2e test')"
        run: |
          newman run "./postman/collections/API-Gateway-ERC721-Regression-Tests.postman_collection.json" --environment "./postman/envs/Developer-portal.postman_environment.json" --insecure
     
